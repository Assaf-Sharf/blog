---
layout: single
title: "[JPA] 양방향 연관관계 주인"
date: "2022-01-27 23:51:27"
categories: JPA
tag: [JPA, hibernate]
toc: true
author_profile: true
# sidebar:
#   nav: "docs"
---

## ✔ 양방향 매핑

<img width="400" height="350" alt="" src="https://user-images.githubusercontent.com/53969142/128630080-4c6e5610-2076-4211-8a47-590692969a91.png">

- **테이블의 연관관계**에는 **방향**이라는 **개념이 존재하지 않는다**.
  - 기본키와 외래키를 조인하여 양방향으로 접근이 가능하다.
- **객체**(Entity)는 참조의 개념을 사용하기 때문에 Id값만 있을 시 양방향 접근이 불가능하다.

```java
@OneToMany(mappedBy = "team")
private List<Member> members = new ArrayList<Member>();
```

- 양방향 매핑을 위해 위에서는 @OneToMany(mappedBy = "team")를 선언
  - Member -> Team
  - Team -> Member

## ✔ 연관관계의 주인과 mappedBy

- mappedBy = JPA의 고 난이도
- mappedBy는 처음에 이해하기 어렵다
- 객체와 테이블간에 연관관계를 맺는 차이를 이해해야 한다

### ✅ 객체와 테이블이 관계를 맺는 차이

> 객체는 2개의 관계, 테이블은 1개의 관계

- 객체 연관관계 = **2개**
  - 회원 -> 팀 연관관계 1개 (단방향)
  - 팀 -> 회원 연관관계 1개 (단방향)
- 테이블 연관관계 = **1개**
  - 회원 <-> 팀의 연관관계 1개 (양방향)

### ✅ 객체의 양방향 관계

- 객체의 양방향 관계는 사실 **양방향 관계가 아니라** **서로 다른 단방향 관계 2개다**
- 객체를 양방향으로 참조하려면 단방향 연관관계를 2개 만들어야 한다
- A -> B (a.getB())

```java
    class A {
      B b;
    }
```

- B -> A (b.getA())

```java
    class B {
      A a;
    }
```

## ✔ ✅ 테이블의 양방향 연관관계

- **테이블**은 **외래 키 하나**로 **두 테이블의 연관관계**를 관리
- MEMBER.TEAM_ID 외래 키 하나로 양방향 연관관계를 가짐 ( 양쪽 조인 가능 )

### MEMBER

```sql
SELECT *
FROM MEMBER M
JOIN TEAM T ON M.TEAM_ID = T.TEAM_ID
```

### TEAM

```sql
SELECT *
FROM TEAM T
JOIN MEMBER M ON T.TEAM_ID = M.TEAM_ID
```

- 위에서 말하고자 하는 것은 외래키 하나로 어떤 테이블에서도 데이터를 가져올 수 있다는 점

### ✨ 둘중 하나로 외래 키를 관리해야 한다

<img width="550" height="400" alt="" src="https://user-images.githubusercontent.com/53969142/151352329-33a1d34e-b753-48ec-b8b9-3331d5f8b9df.PNG">

- **그렇다면 둘 중에 어떤 걸로 매핑을 해야 할까?**
- Member(Entity)로 외래키를 관리할지, Team(Entity)로 관리할지 결정해야 한다.
- 여기서 룰이 생긴다
- DB 입장에서는 TEAM_ID(FK)만 업데이트 되면 된다

## ✔ 연관관계의 주인

### ✨ 양방향 매핑 규칙

- 객체의 두 관계 중 하나를 **연관관계의 주인**으로 지정
- 연관관계의 주인만이 외래 키를 관리 - 등록, 수정
- **주인이 아닌쪽은 읽기만 가능**
- 주인은 mappedBy 속성 사용을 하지 않는다
- 주인이 아니면 mappedBy 속성으로 주인 지정

### ✨ 누구를 주인으로?

<img width="530" height="370" alt="" src="https://user-images.githubusercontent.com/53969142/151353983-6a4911a9-dd2b-4872-9b08-de5297be963d.PNG">

- <mark style='background-color: #f1f8ff'>외래 키가 있는 곳을 주인으로 정해라.</mark>
- 위 사진에서는 **Member.team**이 **연관관계의 주인**이다.
- DB에서 1 : **N** 쪽에 해당되는 곳이 **연관관계의 주인**이라 생각한다.

### 참고 자료

- [양방향 연관관계 주인](https://www.inflearn.com/course/ORM-JPA-Basic/lecture/21697)
