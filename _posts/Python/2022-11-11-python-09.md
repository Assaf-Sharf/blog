---
title:  "[Python] Pandas를 활용해 downcast로 메모리 부담 줄이기"
layout: single

categories: "Python"
tags: 
    - Python
    - Pandas
    - Downcast

toc: true
toc_sticky: true
toc_label : "목차"
toc_icon: "bars"
---

<small>Pandas의 ```to_numeric``` 함수를 이용해 메모리 용량 줄이기 (downcast)</small>

***

# ✔️ Downcast 란?
- pandas 의 ```to_numeric``` 함수에서 선택적으로 사용할 수 있는 파라미터이다.
- 정형 데이터에 dtype(float, integer, signed, unsigned)를 지정해 가장 작은 버전으로 낮춰 메모리를 절약할 수 있다.

## 🔍 pandas.to_nemeric
- 인수를 숫자형으로 전환하는 기능
- 기본적으로 반환되는 dtype은 데이터에 따라 float64, int64 이다.
  - 다른 dtype을 설정하려면 downcast 매개변수를 이용하면 된다.

### ➰ 주요 파라미터
기본 구조 : ```pandas.to_numeric(arg, errors='raise', downcast=None)```

- ```arg``` : scalar, list, tuple, 1-d array, series
  - 전환할 인수

- ```errors``` : ignore, raise, coerce (기본값 : raise) 
  - raise : 잘못된 구문 분석은 예외를 발생시킴
  - coerce : 잘못된 구문 분석이 NaN으로 설정됨
  - ignore : 잘못된 구문 분석이 입력을 반환함

- ```downcast``` : str (기본값 : None)
  - integer, signed, unsigned, float 일 수 있음
  - None이 아닌 숫자 dtype으로 캐스트된 경우, 결과 데이터를 가장 작은 숫자 dtype으로 downcast
    - interger, signed : 최소 np.int8
    - unsigned : 최소 np.uint8
    - float : 최소 np.float32

## 🔍 Data type
- <mark style="background-color: #f6f8fa">int</mark> : 정수 (음의 정수, 0, 양의 정수)
- <mark style="background-color: #f6f8fa">uint</mark> : 양수 (0, 양의 정수)
- <mark style="background-color: #f6f8fa">float</mark> : 실수 (부동 소수형)
- <mark style="background-color: #f6f8fa">complex</mark> : 복소수 (실수 + 허수)
- <mark style="background-color: #f6f8fa">bool</mark> : true, false

|    | Data type   | Description |
|---:|:------------|:------------|
|  0 |bool| Boolean (True or False) stored as a byte|
|  1 |int|Platform integer (normally either int32 or int64)|
|  2 |int8|Byte (-128 to 127)|
|  3 |int16|Integer (-32768 to 32767)|
|  4 |int32|Integer (-2147483648 to 2147483647)|
|  5 |int64|Integer (-9223372036854775808 to 9223372036854775807)|
|  6 |uint8|Unsigned integer (0 to 255)|
|  7 |uint16|Unsigned integer (0 to 65535)|
|  8 |uint32|Unsigned integer (0 to 4294967295)|
|  9 |uint64|Unsigned integer (0 to 18446744073709551615)|
| 10 |float|Shorthand for float64.|
| 11 |float16|Half precision float: sign bit, 5 bits exponent, 10 bits mantissa|
| 12 |float32|Single precision float: sign bit, 8 bits exponent, 23 bits mantissa|
| 13 |float64|Double precision float: sign bit, 11 bits exponent, 52 bits mantissa|
| 14 |complex|Shorthand for complex128.|
| 15 |complex64|Complex number, represented by two 32-bit floats|
| 16 |complex128|Complex number, represented by two 64-bit floats|

<br>

# ✔️ Downcast 필요성

컴퓨터가 프로그램을 실행하는 과정을 간단히 해보면 아래 네단계를 거친다.
1. CPU가 코드 실행에 필요한 데이터들을 하드디스크에 가져온다.
2. 가져온 데이터를 RAM 메모리에 올린다.
3. CPU가 연산작업을 하여 결과물을 받아온다.
4. 사용자에게 결과물을 반환한다.

데이터는 컴퓨터 RAM 용량만큼 불러올 수 있는데, 대용량 데이터를 불러와서 분석하거나 모델을 만들기 위해서는 메모리를 효율적으로 사용할 수 있어야 한다. <mark style="background-color: #f6f8fa">downcast가 필요한 이유</mark>는 메모리 사용량을 절약해 더 많은 데이터를 불러오고 더 많은 데이터를 분석하기 위해서이다!

<br>

# ✔️ Downcast 적용 및 모니터링
- pandas에서 제공하는 ```to_numeric``` 함수의 ```downcast``` 파라미터를 사용하면 정형 데이터의 용량을 줄일 수 있다.
- 메모리 사용량은 ```info``` 함수에서 확인할 수 있다.
  - 메모리 사용량 값만 보고싶을 땐, ```memory_usage``` 함수 사용

## 🔍 실습으로 이해하기
- Dataset : Kaggle 타이타닉 - train.csv
- [👉 데이터 보러가기](https://www.kaggle.com/competitions/titanic/data)


```python
import pandas as pd

file_names = "data/titanic/train.csv"
df = pd.read_csv(file_names, index_col="PassengerId")
df.head()
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Survived</th>
      <th>Pclass</th>
      <th>Name</th>
      <th>Sex</th>
      <th>Age</th>
      <th>SibSp</th>
      <th>Parch</th>
      <th>Ticket</th>
      <th>Fare</th>
      <th>Cabin</th>
      <th>Embarked</th>
    </tr>
    <tr>
      <th>PassengerId</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>3</td>
      <td>Braund, Mr. Owen Harris</td>
      <td>male</td>
      <td>22.0</td>
      <td>1</td>
      <td>0</td>
      <td>A/5 21171</td>
      <td>7.2500</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>1</td>
      <td>Cumings, Mrs. John Bradley (Florence Briggs Th...</td>
      <td>female</td>
      <td>38.0</td>
      <td>1</td>
      <td>0</td>
      <td>PC 17599</td>
      <td>71.2833</td>
      <td>C85</td>
      <td>C</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>3</td>
      <td>Heikkinen, Miss. Laina</td>
      <td>female</td>
      <td>26.0</td>
      <td>0</td>
      <td>0</td>
      <td>STON/O2. 3101282</td>
      <td>7.9250</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>1</td>
      <td>Futrelle, Mrs. Jacques Heath (Lily May Peel)</td>
      <td>female</td>
      <td>35.0</td>
      <td>1</td>
      <td>0</td>
      <td>113803</td>
      <td>53.1000</td>
      <td>C123</td>
      <td>S</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0</td>
      <td>3</td>
      <td>Allen, Mr. William Henry</td>
      <td>male</td>
      <td>35.0</td>
      <td>0</td>
      <td>0</td>
      <td>373450</td>
      <td>8.0500</td>
      <td>NaN</td>
      <td>S</td>
    </tr>
  </tbody>
</table>
</div>




```python
df.describe()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Survived</th>
      <th>Pclass</th>
      <th>Age</th>
      <th>SibSp</th>
      <th>Parch</th>
      <th>Fare</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>891.000000</td>
      <td>891.000000</td>
      <td>714.000000</td>
      <td>891.000000</td>
      <td>891.000000</td>
      <td>891.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>0.383838</td>
      <td>2.308642</td>
      <td>29.699118</td>
      <td>0.523008</td>
      <td>0.381594</td>
      <td>32.204208</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.486592</td>
      <td>0.836071</td>
      <td>14.526497</td>
      <td>1.102743</td>
      <td>0.806057</td>
      <td>49.693429</td>
    </tr>
    <tr>
      <th>min</th>
      <td>0.000000</td>
      <td>1.000000</td>
      <td>0.420000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>0.000000</td>
      <td>2.000000</td>
      <td>20.125000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>7.910400</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>0.000000</td>
      <td>3.000000</td>
      <td>28.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>14.454200</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>1.000000</td>
      <td>3.000000</td>
      <td>38.000000</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>31.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>1.000000</td>
      <td>3.000000</td>
      <td>80.000000</td>
      <td>8.000000</td>
      <td>6.000000</td>
      <td>512.329200</td>
    </tr>
  </tbody>
</table>
</div>




```python
df.info()
```

    <class 'pandas.core.frame.DataFrame'>
    Int64Index: 891 entries, 1 to 891
    Data columns (total 11 columns):
     #   Column    Non-Null Count  Dtype  
    ---  ------    --------------  -----  
     0   Survived  891 non-null    int64  
     1   Pclass    891 non-null    int64  
     2   Name      891 non-null    object 
     3   Sex       891 non-null    object 
     4   Age       714 non-null    float64
     5   SibSp     891 non-null    int64  
     6   Parch     891 non-null    int64  
     7   Ticket    891 non-null    object 
     8   Fare      891 non-null    float64
     9   Cabin     204 non-null    object 
     10  Embarked  889 non-null    object 
    dtypes: float64(2), int64(4), object(5)
    memory usage: 83.5+ KB



```python
# downcast 전 메모리 사용량 (KB 단위로 보기 위해 1024로 나눔)
before_downcast = df.memory_usage().sum() / 1024
```


```python
def dtype_downcast(data):
    
    # 데이터프레임의 전체 컬럼에 대해 downcast 적용
    for col in df.columns:
        # 컬럼별 데이터타입을 dtype_name 변수에 할당
        dtype_name = df[col].dtypes.name
        # dtype이 int로 시작하는 경우
        if dtype_name.startswith("int"):
            # 0이상의 값만 가지는 컬럼인 경우
            if df[col].min() >= 0:
                # 0과 양의 정수만 포함하는 uint로 전환
                df[col] = pd.to_numeric(df[col], downcast="unsigned")
            # 0이하의 값도 포함하는 컬럼인 경우
            else:
                # 음의 정수, 0, 양의 정수를 포함하는 int로 전환
                df[col] = pd.to_numeric(df[col], downcast="integer")
        # dtype이 float로 시작하는 경우
        elif dtype_name.startswith("float"):
            # 가장 작은 버전의 float 타입으로 전환
            df[col] = pd.to_numeric(df[col], downcast="float")
            
dtype_downcast(df)
```


```python
df.info()
```

    <class 'pandas.core.frame.DataFrame'>
    Int64Index: 891 entries, 1 to 891
    Data columns (total 11 columns):
     #   Column    Non-Null Count  Dtype  
    ---  ------    --------------  -----  
     0   Survived  891 non-null    uint8  
     1   Pclass    891 non-null    uint8  
     2   Name      891 non-null    object 
     3   Sex       891 non-null    object 
     4   Age       714 non-null    float32
     5   SibSp     891 non-null    uint8  
     6   Parch     891 non-null    uint8  
     7   Ticket    891 non-null    object 
     8   Fare      891 non-null    float32
     9   Cabin     204 non-null    object 
     10  Embarked  889 non-null    object 
    dtypes: float32(2), object(5), uint8(4)
    memory usage: 52.2+ KB



```python
# downcast 후 메모리 사용량 (KB 단위로 보기 위해 1024로 나눔)
after_downcast = df.memory_usage().sum() / 1024
```

```python
print(f"downcast 전 : {before_downcast:.1f}KB")
print(f"downcast 후 : {after_downcast:.1f}KB")
print(f"절약한 총 메모리 양 : {(before_downcast - after_downcast):.1f}KB")
```

    downcast 전 : 83.5KB
    downcast 후 : 52.2KB
    절약한 총 메모리 사용량 : 31.3KB

<br>

# ✔️ 마치며
정형 데이터를 pandas의 ```to_numeric``` 함수를 사용하여 낮은 버전의 dtype으로 바꿈으로써 메모리 사용량을 줄여보았다.
<br>내 컴퓨터의 RAM 사양을 고려하여 downcast로 데이터를 똑똑하게 사용하자.

<br>

# ✔️ Reference
- [멋쟁이사자처럼 AI SCHOOL] 박조은 강사님 강의자료 
- [Github by rougier, numpy-tutorial](https://github.com/rougier/numpy-tutorial#quick-references)
- [pandas 공식문서, pandas.to_numeric](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.to_numeric.html?highlight=to_numeric)
- [벨로그 by JinBaek, 메모리와 데이터 타입](https://velog.io/@jinmb0602/%EB%A9%94%EB%AA%A8%EB%A6%AC%EC%99%80-%EB%8D%B0%EC%9D%B4%ED%84%B0-%ED%83%80%EC%9E%85)
- [티스토리 by Kims, [Python] 자료형(type) 확인과 numpy 데이터 형변환](https://eehoeskrap.tistory.com/295)
- [네이버블로그 by 꾸준희, [Python][Pandas] Big Data 메모리 사용량 줄이기(MemoryError)](https://m.blog.naver.com/wideeyed/221578747562)

<br>

👩🏻‍💻개인 공부 기록용 블로그입니다
<br>오류나 틀린 부분이 있을 경우 댓글 혹은 메일로 따끔하게 지적해주시면 감사하겠습니다.
{: .notice}