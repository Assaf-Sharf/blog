---
layout: single
title:  "[SpringDB2] 테스트 - 데이터 접근 기술2"
categories: SpringDB
tag: [web, server, DB, spring boot, spring mvc, java, thymeleaf]
toc: true
toc_sticky: true
author_profile: false
sidebar:
    nav: "docs"
---

<br>

# 테스트 - 임베디드 모드 DB

**임베디드 모드**<br>
H2 데이터베이스는 자바로 개발되어 있고, JVM안에서 메모리 모드로 동작하는 특별한 기능을 제공한다. 그래서 애플리케이션을 실행할 때 H2 데이터베이스도 해당 JVM 메모리에 포함해서 함께 실행할 수 있다.<br>
DB를 애플리케이션에 내장해서 함께 실행한다고 해서 임베디드 모드라 한다. 물론, 애플리케이션이 종료되면 임베디드 모드로 동작하는 H2 데이터베이스도 함께 종료되고, 데이터도 모두 사라진다.

## 임베디드 모드 직접 사용

```java
@Slf4j
@Import(JdbcTemplateV3Config.class)
@SpringBootApplication(scanBasePackages = "hello.itemservice.web")
public class ItemServiceApplication {
    
    public static void main(String[] args) {
        SpringApplication.run(ItemServiceApplication.class, args);
    }

    ...

    @Bean
    @Profile("test")
    public DataSource dataSource() {
        log.info("메모리 데이터베이스 초기화");
        DriverManagerDataSource dataSource = new DriverManagerDataSource();
        dataSource.setDriverClassName("org.h2.Driver");
        dataSource.setUrl("jdbc:h2:mem:db;DB_CLOSE_DELAY=-1");
        dataSource.setUsername("sa");
        dataSource.setPassword("");
        return dataSource;
    }
}
```
- `@Profile("test")`
    - 프로필이 `test`인 경우에만 데이터소스를 스프링 빈으로 등록한다.
    - 테스트 케이스에서만 이 데이터소스를 스프링 빈으로 등록해서 사용하겠다는 의미다.
- `dataSource()`
    - `jdbc:h2:mem:db`: 데이터소스를 만들때 이렇게 적으면 임베디드 모드(메모리 모드)로 동작하는 H2 데이터베이스를 사용할 수 있다.
    - `DB_CLOSE_DELAY=-1`: 임베디드 모드에서는 데이터베이스 커넥션 연결이 모두 끊어지면 데이터베이스도 종료되는데, 그것을 방지하는 설정이다.
    - 이 데이터소스를 사용하면 메모리 DB를 사용할 수 있다.

**스프링 부트 - 기본 SQL 스크립트를 사용해서 데이터베이스를 초기화하는 기능**<br>
메모리 DB는 애플리케이션이 종료될 때 함께 사라지기 때문에, 애플리케이션 실행 시점에 데이터베이스 테이블도 새로 만들어주어야 한다.<br>
스프링 부트는 SQL 스크립트를 실행해서 애플리케이션 로딩 시점에 데이터베이스를 초기화하는 기능을 제공한다.<br>

`src/test/resources/schema.sql`
```sql
drop table if exists item CASCADE;
create table item
(
    id bigint generated by default as identity,
    item_name varchar(10),
    price integer,
    quantity integer,
    primary key (id)
);
```

<br>

# 스프링 부트와 임베디드 모드

스프링 부트는 임베디드 데이터베이스에 대한 설정도 기본으로 제공하기 때문에 데이터베이스에 대한 별다른 설정이 없으면 임베디드 데이터베이스를 사용한다.
<br>

앞서 직접 설정했던 메모리 DB용 데이터소스는 필요없다.
```java
@Slf4j
@Import(JdbcTemplateV3Config.class)
@SpringBootApplication(scanBasePackages = "hello.itemservice.web")
public class ItemServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(ItemServiceApplication.class, args);
    }

    @Bean
    @Profile("local")
    public TestDataInit testDataInit(ItemRepository itemRepository) {
        return new TestDataInit(itemRepository);
    }

    /*
    @Bean
    @Profile("test")
    public DataSource dataSource() {
        log.info("메모리 데이터베이스 초기화");
        DriverManagerDataSource dataSource = new DriverManagerDataSource();
        dataSource.setDriverClassName("org.h2.Driver");
        dataSource.setUrl("jdbc:h2:mem:db;DB_CLOSE_DELAY=-1");
        dataSource.setUsername("sa");
        dataSource.setPassword("");
        return dataSource;
    }
    */
}
```

그리고 테스트에서 데이터베이스에 접근하는 설정 정보도 주석처리 한다.<br>

`/src/test/resources/application.properties`
```properties
spring.profiles.active=test
#spring.datasource.url=jdbc:h2:tcp://localhost/~/testcase
#spring.datasource.username=sa
#jdbcTemplate sql log
```
이렇게 하면 데이터베이스에 접근하는 모든 설정 정보가 사라지게 된다.<br>
이렇게 별다른 정보가 없으면 스프링 부트는 임베디드 모드로 접근하는 `DataSource`를 만들어서 제공한다.


<br>

<출처 : [인프런 - 스프링 DB 2편 : 데이터 접근 활용 기술(김영한)](https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-db-2/dashboard)>