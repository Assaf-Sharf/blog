# 2023-01-02-10

# 10장 함수

함수는 값을 반환하는 PL/SQL 블록의 일종이다. 프로시저는 값을 하나도 반환하지 않거나 여러건의 값을 반환할 수 있지만 한수는 단 하나의 결과값을 반환 해야하는 특징을 가짐

또 다른 차이점은 함수는 SQL문에서 바로 호출하여 사용할 수 있다는 점 그러나 SQL 문에서 무분별하게 함수를 호출하여 사용하면 성능이 저하될 수 있으므로 주의가 필요함

### 함수 생성

기본적인 생성 구문은 프로 시저와 거의 동일합니다. 입력 매개변수가 없을 경우에는 Default 구문을 사용하여 기본 값을 설정할 수 있으며, RETURN 문과 함께 반환할 값의 데이터 타입을 선언해야 합니다. 또한 함수 내에 반드시 하나 이상의 RETURN문이 포함되어야 합니다.

4개의 값을 입력 받아 평균 값을 반환하는 함수를 생성하는 예 반환(RETURN)할 변수의 데이터 타입을 Number형으로 선언하고, Return 함수를 이용하여 평균 값을 반환하도록 하였습니다. 만일 하나 이상의 결과 값이 반환되면 에러가 발생하므로 주의가 필요합니다.

그리고 SQL DUAL 문을 이용하여 함수가 실행되도록 하였습니다.

```sql
CREATE OR REPLACE FUNCTION get_avg_func(p_deptno NUMBER)
RETURN NUMBER
IS

	I_result NUMBER := 0;
BEGIN

	SELECT AVG(sal)
		INTO I_result
		FROM emp
		WHERE deptno = p_deptno;
	
	RETURN I_result;
END;
/

--sql을 이용하여 함수 수행
SELECT get_avg_func(10) FROM dual;
```

 

### Deterministic 함수 생성

Deterministic 함수란 동일한 입력 값이 들어올 경우 출력 값도 동일함을 보장하는 함수. 함수 기반 인덱스 (Function Based Index)와 같이 입력 값이 동일하면 동일한 결과 값이 출력 되어야 하는 함수에 대해서는 Deterministic 함수로 정의 할 수 있습니다.

함수를 Deterministic으로 선언하면 동일한 입력 값에 대해서는 캐시를 이용해 결과 값을 저장해 두었다가 이전에 사용된 동일한 값이 들어오면 함수를 수행하지 않고 캐시에 저장된 결과 값을 출력하므로 성능이 좋아 질 수 있습니다. 그러나 시간이 지나면 값이 변경될 수 있는 경우 또는 동일한 입력 값이 사용되지 않는 경우(칼럼의 변별력이 좋은경우)에는 주의해서 사용해야 합니다.

```sql
CREATE OR REPLACE FUNCTION <proc_name> (<param> VARCHAR2 default null)
DETERMINISTIC
IS
	<vairable declaration>
BEGIN
	<logic>
EXCEPTION
	<exception>
END <proc_name>;
/
```

### 함수 실행

아래는 생성된 함수를 실행하는 방법입니다.

SQLPLUS에서 실행할 경우 결과 값을 저장할 변수를 선언 한 후 EXEC 명령을 이용해 수행

```sql
-- 함수 실행
EXEC :I_result := get_avg_func(10);

--결과 출력
PRINT I_result;
```

다음으로 PL/SQL 블록으로도 실행 가능

```sql
DECLARE
	I_result NUMBER;

BEGIN
	I_result := get_avg_func(10);

	DBMS_OUTPUT.PUT_LINE('result :' || ROUND(I_result,2));
END;
/
```

### 함수 제거

불필요한 함수는 아래와 같이 삭제 가능

DROP FUNCTION function_name;

 프로시저와 함수의 차이

아래의 표는 프로시저와 함수의 차이점을 요약한 내용입니다. 가장 큰 차이점으로는 함수에는 반드시 RETURN 절이 포함되어야 하고 하나의 결과만 반환할 수 있다는 것입니다. 또한 함수는 표현식의 부분으로서 프로시저나 함수의 입력 매개변수 위치에서 실행이 가능하며 SQL 안에서도 자유롭게 실행 할 수 있습니다.

| 프로시저 | 함수 |
| --- | --- |
| PL/SQL 블록에서 실행 | 표현식의 부분으로 실행될 수 있음(프로시저, 함수의 입력 매개변수 위치에서 함수를 사용 가능함) |
| 선언부에 RETURN 절이 없음 | 반드시 선언부에 RETURN 절이 필요함 |
| 반환 값이 없거나 하나 또는 여러 건의 결과가 반환 될 수 있음 | 반드시 하나의 값만 반환될 수 있음 |
| RETURN 문이 필요 없음 | 적어도 한번은 반드시 RETURN문이 포함되어야 함 |