---
published: true
title:  "[elastic 프로젝트] 애플리케이션 검색 웹 서비스 만들기"
excerpt: ""
categories:
- Elastic
tags:
- [elastic cloud, elasticsearch, logstash, kibana, django, python, ngrok]
last_modified_at: 2022-04-12
---

> 상명대학교 elastic 팀 프로젝트에 참여하며 공부했던 것들을 기록하기 위해 작성한 글

`elastic cloud` `elasticsearch` `logstash` `kibana` <br>
`python` `python-elasticsearch-api` `Django` `TailwindCSS` `ngrok` <br><br>


팀의 목표는 애플과 안드로이드 어플 모두 검색 가능한 검색 웹 서비스를 제공하는 것이다. 앱 데이터를 계속 수집하여 우리 팀만의 히스토리를 만들고, 그걸 웹 사이트 내에 나타내어 사용자가 시간에 따른 앱의 트렌드를 볼 수 있도록 만들고자 한다. 

<br>

앱 데이터는 `3월 15일` 부터 수집하였고, 현재는 하루에 한 번으로 크롤러 주기를 설정한 상태이다. 크롤링 결과를 저장한 index의 storage size를 확인했을 때 크지않아서 년 단위로 크롤링 주기를 설정해도 괜찮겠다는 피드백을 받았는데, 이 것을 적용하는 것과 이 프로젝트를 지속적으로 운용하는 것에 대해선 후에 **추가할 예정**이다. 

<br>

## 데이터 수집, 저장, 관리

먼저 구글 플레이스토어와 애플의 앱스토어에서 앱 데이터를 크롤링하기 위해 각각의 **크롤러를 구현**했다. (팀 내에서 담당하지 않은 부분입니다.) 

그리고 크롤링 한 데이터를 elastic에 업로드하기 위해 원래는 [파이썬의 elastic API](https://elasticsearch-py.readthedocs.io/en/v8.1.1/)를 사용하려 했다. 그런데 파이썬 코드 내에서 문제가 생길 경우, 크롤링 과정에서 발생한 것인 지 업로드 과정에서 발생한 것인 지, 문제를 정확히 파악하고 수정하기 위해 **로그스태시를 이용하여 업로드**하기로 결정했다. 

<br>

크롤링한 데이터를 `json` 파일로 저장했고, 로그스태시의 `conf` 파일을 아래처럼 구성했다. 
```ruby
input {
    file {
        path => "/[파일이 저장된 경로]/chart-apple-iphone-kr/*.json"
        codec => "json"
    }
}

filter {
    # 불필요한 필드 제거
    mutate {
        remove_field => ["advisories", "appletvScreenshotUrls", "artistId", "artistName", "artistViewUrl", "artworkUrl100", "artworkUrl512", "averageUserRating", "bundleId", "ChartCountry", "ChartDevice", "contentAdvisoryRating", "currency", "features", "fileSizeBytes", "formattedPrice", "genreIds", "genres", "ipadScreenshotUrls", "iPadSupport", "iPhoneSupport", "isGameCenterEnabled", "isVppDeviceBasedLicensingEnabled", "kind", "languageCodesISO2A", "minimumOsVersion", "primaryGenreId", "screenshotUrls", "sellerUrl", "supportedDevices", "trackCensoredName", "trackContentRating", "userRatingCount", "userRatingCountForCurrentVersion", "version", "wrapperType", "CrawlingTimes", "event", "host", "log.file.paath", "releaseNotes"]
    }
}

output {
    # elastic cloud에 접속해서 데이터를 삽입하기 위해 적은 Rest API key
    elasticsearch {
        cloud_id => "[Cloud ID]"
        ssl => true
        ilm_enabled => false
        user => "[user]"
        password => "[password]"
        index => "%{ChartName}-apple-%{+YYYY-MM-dd}"
  }
}
```

대괄호 안에 적은 내용은 다르게 채워야 하는 내용이다. 위 코드의 input에서 file을 여러개 넣어 아래처럼 index를 구성했다. 

<br>

- 앱 스토어 관련 인덱스
	1. 모든 앱에 대한 무료 인기 차트: topfree-apple-YYYY-MM-DD
	2. 모든 앱에 대한 유료 인기 차트: toppaid-apple-YYYY-MM-DD
	3. 모든 앱에 대한 앱 수입 차트: topgrossing-apple-YYYY-MM-DD
	4. 하위 카테고리에 대한 무료 인기 차트: category-topfree-apple-YYYY-MM-DD-"카테고리 ID"


- 플레이 스토어 관련 인덱스:
	1. 모든 앱에 대한 무료 인기 차트: topfree-google-YYYY-MM-DD
	2. 모든 앱에 대한 유료 인기 차트: toppaid-google-YYYY-MM-DD
	3. 모든 앱에 대한 앱 수입 차트: topgrossing-google-YYYY-MM-DD
	4. 하위 카테고리에 대한 무료 인기 차트: category-topfree-google-YYYY-MM-DD-"카테고리이름"

<br>

또한 인덱스 내에 필요한 필드들의 기존 매핑정보를 확인한 뒤 `index templates`로 **매핑 정보를 수정**하는 과정을 거쳤다. 

|                    | app store                          | 자료형        | play store  | 자료형               |
| ------------------ | ---------------------------------- | ------------- | ----------- | -------------------- |
| 아이콘 이미지 주소 | artworkUrl60                       | keyword       | icon        | keyword              |
| 현재 평점          | averageUserRatingForCurrentVersion | float         | score       | double > float       |
| 앱 링크            | trackViewUrl                       | keyword       | url         | keyword              |
| 앱 이름            | trackName                          | text, keyword | title       | text > text, keyword |
| 출시일             | releaseDate                        | date          | released    | date                 |
| 메인 장르          | primaryGenreName                   | text, keyword | genre       | text, keyword        |
| 업데이트 시간      | currentVersionReleaseDate          | date          | updated     | date                 |
| 판매자명           | sellerName                         | keyword       | developer   | keyword              |
| 모든 카테고리      | genres                             |               |             |                      |
| 가격               | price                              | float         | price       | float                |
| 상세설명           | description                        | text, keyword | description | text > text, keyword |
| 순위               | Ranking                            | byte          | Ranking     | byte                 |

<br> 

마지막으로 키바나 대시보드를 구성하였고, 구성한 대시보드를 웹 페이지에 보여주었다. (팀 내에서 담당하지 않은 부분으로 대시보드의 일부만 가져왔다. ) 


<p align="center"><img height="70%" width="70%" src="https://user-images.githubusercontent.com/83692497/162900592-99b850dc-0889-4428-bb7c-0688d064f908.jpg"/>
<img height="70%" width="70%" src="https://user-images.githubusercontent.com/83692497/162900639-4ea61732-9e0f-4b3f-830d-cca88a239f8c.jpg"/></p>

<br>

아래부터는 Django를 이용하여 구현한 검색 웹 사이트를 만드는 과정을 간단히 적었다.

<br>

## 웹 구현 (진행중)

구현해야 할 것이 남아서 진행중이라 적어놓았고, 완료가 되면 사진과 함께 글을 **수정할 예정**이다.
- [ ] index template 적용 
- [ ] 검색 기능 개선
- [ ] CSS 추가
- [ ] 엘라스틱 API 관련 코드 따로 함수로 만들기 (리팩토링)

<br>

### Django, elastic cloud 연동

장고에서 elastic cloud에 접근하기 위해 아래의 코드를 사용했다. 
```python
es = Elasticsearch(
    cloud_id="[Cloud ID]",
    http_auth=("[user]", "[password]"),
    )
```

<br>

### 검색 기능 구현 (추가 예정)


### 로컬 PC를 외부에 공유하기

발표를 위해 localhost를 공유용 링크로 전달해야 했는데, 구글링한 결과로 `ngrok`과 `localtunnel`에 대해 알게 되었다.  

localtunnel의 경우 윈도우 환경에서 사용하기 쉽지 않은 듯해서 ngrok을 사용하게 되었다. ngrok의 무료버전을 사용하면 1분당 40개 커넥션만 받을 수 있고, 최대 1개의 ngrok만 실행시킬 수 있지만, 간단한 발표용이었기에 무료 버전 ngrok을 사용했다.

<br>

아래는 ngrok으로 로컬 pc를 외부에 공유하는 방법이다. (당연히 localhost에 서버가 돌아가고 있어야 함)
1. ngrok 공식 사이트에서 계정을 만들고, ngrok을 다운로드 한다. 
2. 압출폴더를 열고, ngrok이 위치한 폴더로 이동해서 `./ngrok authtoken [개인 token]` 를 입력해 내 계정과 연결한다. 
3. `./ngrok http [내 서버가 위치한 포트넘버]` (장고는 localhost:8000)
4. public URL 사용!


<br>

## 참고
- [Python Elasticsearch API](https://elasticsearch-py.readthedocs.io/en/v8.1.1/)

- [Django, elastic cloud 연동](https://www.elastic.co/guide/en/elasticsearch/client/python-api/7.17/connecting.html)
  
- 검색 기능 구현
  - https://blog.nerdfactory.ai/2019/04/29/django-elasticsearch-restframework.html
  - https://dianakang.tistory.com/52

- [노마드코더 ngrok](https://www.youtube.com/watch?v=0lUJvVqSEkY)
